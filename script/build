#!/bin/sh

SHELL_FILE="'`pwd`/shell.js'"
EXPORTS=`pwd`/exports.json

if test "$#" -gt 0; then
  cores=$@
else
  cores=core/*
fi

for core in $cores
do
  (cd $core && emmake make platform=emscripten)
done

for core in $cores
do
  BC_FILE=`find $core -name '*.bc' -print`
  DIR=`pwd`
  (cd `dirname $BC_FILE` && \
    emcc `basename $BC_FILE` -O3 -Oz -o ${DIR}/$core/core.js --memory-init-file 0 --closure 1 \
      -s RESERVED_FUNCTION_POINTERS=${RESERVED_FUNCTION_POINTERS-50} \
      -s TOTAL_MEMORY=${TOTAL_MEMORY-268435456} \
      -s EXPORTED_FUNCTIONS=@$DIR/exports.json \
      -s EXPORTED_RUNTIME_METHODS=@$DIR/runtime_exports.json \
      -s SHELL_FILE=$SHELL_FILE \
      -s AGGRESSIVE_VARIABLE_ELIMINATION=1 \
      -s OUTLINING_LIMIT=20000 \
  )
  cp retro.js $core
done
